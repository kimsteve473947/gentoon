generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ì‚¬ìš©ì ëª¨ë¸ (Supabase Authì™€ ì—°ë™)
model User {
  id                String         @id // Supabase Authì˜ user.idë¥¼ ì§ì ‘ ì‚¬ìš©
  email             String         @unique
  name              String?
  avatarUrl         String?        // Supabase í•„ë“œëª… í†µì¼
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // êµ¬ë… ì •ë³´
  subscription      Subscription?
  
  // ìŠ¤í† ë¦¬ì§€ ì •ë³´
  storage           UserStorage?
  
  // ê´€ê³„
  projects          Project[]
  characters        Character[]
  elements          Element[]        // âœ¨ ìš”ì†Œ ì¶”ê°€
  generations       Generation[]
  transactions      Transaction[]
  referralCode      String         @unique @default(uuid())
  referredBy        String?
  referralRewards   ReferralReward[] @relation("referrer")
  referredRewards   ReferralReward[] @relation("referred")
  
  // ğŸš€ ì„±ëŠ¥ ìµœì í™” ê´€ê³„
  dailyUsageStats   DailyUsageStats[]
  usageCache        UserUsageCache?
  
  // ğŸš€ ê³ ê° ì§€ì›
  inquiries         Inquiry[]
  
  @@index([id])
  @@index([email])
  @@map("user")
}

// êµ¬ë… ëª¨ë¸
model Subscription {
  id                String         @id @default(uuid())
  userId            String         @unique
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // í”Œëœ ì •ë³´
  plan              SubscriptionPlan @default(FREE)
  tokensTotal       Int            @default(0)
  tokensUsed        Int            @default(0)
  maxCharacters     Int            @default(1)
  
  // ê²°ì œ ì •ë³´
  tossBillingKey    String?        // ë¹Œë§í‚¤ (ì •ê¸°ê²°ì œìš©)
  tossCustomerKey   String?        // ê³ ê° ê³ ìœ  í‚¤
  tossCustomerId    String?        // í† ìŠ¤ ê³ ê° ID (deprecated)
  tossSubscriptionId String?       // í† ìŠ¤ êµ¬ë… ID (deprecated)
  
  // êµ¬ë… ê¸°ê°„
  currentPeriodStart DateTime      @default(now())
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean       @default(false)
  
  // í† í° ì‚¬ìš©ëŸ‰ ì´ˆê¸°í™” ì¶”ì 
  tokensResetDate    DateTime      @default(now()) // í† í°ì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ˆê¸°í™”ëœ ë‚ ì§œ
  nextTokensReset    DateTime      // ë‹¤ìŒ í† í° ì´ˆê¸°í™” ì˜ˆì •ì¼ (ê²°ì œì¼ ê¸°ì¤€ 30ì¼)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([userId])
  @@map("subscription")
}

// êµ¬ë… í”Œëœ enum
enum SubscriptionPlan {
  FREE        // ë¬´ë£Œ: 10í† í°, ìºë¦­í„° 1ê°œ, í”„ë¡œì íŠ¸ 3ê°œ
  PRO         // í”„ë¡œ: 50ë§Œ í† í°, ìºë¦­í„° 3ê°œ, ë¬´ì œí•œ í”„ë¡œì íŠ¸
  PREMIUM     // í”„ë¦¬ë¯¸ì—„: 200ë§Œ í† í°, ìºë¦­í„° 5ê°œ, ë¬´ì œí•œ í”„ë¡œì íŠ¸
  ADMIN       // ê´€ë¦¬ì: ë¬´ì œí•œ í† í°, ë¬´ì œí•œ ìºë¦­í„°, ë¬´ì œí•œ í”„ë¡œì íŠ¸
}

// ìºë¦­í„° ëª¨ë¸
model Character {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name              String
  description       String         @db.Text
  styleGuide        String?        @db.Text
  
  // ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ë“¤
  referenceImages   Json           // ì›ë³¸ URL ë°°ì—´
  ratioImages       Json?          // ë¹„ìœ¨ë³„ ì²˜ë¦¬ëœ ì´ë¯¸ì§€ { "1:1": [...], "4:5": [...] }
  thumbnailUrl      String?
  
  // ìºë¦­í„° ë©”íƒ€ë°ì´í„° (ì™¸ëª¨, ì˜ìƒ, ì„±ê²© ë“±)
  metadata          Json?          // visualFeatures, clothing, personality, aliases ë“±
  
  isPublic          Boolean        @default(false)
  isFavorite        Boolean        @default(false)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // ê´€ê³„
  generations       Generation[]
  projects          ProjectCharacter[]
  
  @@index([userId])
  @@map("character")
}

// âœ¨ ìš”ì†Œ(Element) ëª¨ë¸ - ìºë¦­í„°ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ ë¹„ìœ¨ ì²˜ë¦¬ ì—†ìŒ
model Element {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name              String
  description       String?        @db.Text
  
  // ì´ë¯¸ì§€ ì •ë³´ (ë¹„ìœ¨ ì²˜ë¦¬ ì—†ì´ ë‹¨ìˆœ ì €ì¥)
  imageUrl          String         // WebPë¡œ ë³€í™˜ëœ ì›ë³¸ ì´ë¯¸ì§€
  thumbnailUrl      String?        // ì‘ì€ ì¸ë„¤ì¼
  
  // ìš”ì†Œ ë©”íƒ€ë°ì´í„°
  category          String?        // ì‚¬ìš©ì ì •ì˜ ì¹´í…Œê³ ë¦¬
  tags              Json?          // íƒœê·¸ë“¤ ë°°ì—´
  
  isPublic          Boolean        @default(false)
  isFavorite        Boolean        @default(false)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([userId])
  @@map("element")
}

// í”„ë¡œì íŠ¸ ëª¨ë¸
model Project {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title             String
  description       String?        @db.Text
  thumbnailUrl      String?        // ìë™ ìƒì„±ëœ ì¸ë„¤ì¼
  panelCount        Int            @default(0)  // í”„ë¦¬ì»´í“¨íŒ…ëœ íŒ¨ë„ ê°œìˆ˜
  
  // ğŸš€ ì„±ëŠ¥ ìµœì í™” í•„ë“œ ì¶”ê°€
  lastPanelImageUrl String?        // ë§ˆì§€ë§‰ìœ¼ë¡œ ìƒì„±ëœ ì´ë¯¸ì§€
  isEmpty           Boolean        @default(true)   // ë¹ˆ í”„ë¡œì íŠ¸ ì—¬ë¶€
  hasContent        Boolean        @default(false)  // ì‹¤ì œ ì½˜í…ì¸  ìœ ë¬´
  contentSummary    String?        // "3ê°œ íŒ¨ë„, 2ê°œ ì´ë¯¸ì§€" í˜•íƒœ
  lastEditedAt      DateTime       @updatedAt       // ë§ˆì§€ë§‰ í¸ì§‘ ì‹œê°„ (ì •ë ¬ìš©)
  
  status            ProjectStatus  @default(DRAFT)
  isPublic          Boolean        @default(false)
  
  // ì‚­ì œ ê´€ë ¨ (íœ´ì§€í†µ ê¸°ëŠ¥)
  deletedAt         DateTime?      // soft delete
  
  // ë©”íƒ€ë°ì´í„°
  metadata          Json?          // ì¶”ê°€ ì„¤ì • ì •ë³´
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  publishedAt       DateTime?
  
  // ê´€ê³„
  panels            Panel[]
  generations       Generation[]
  characters        ProjectCharacter[]
  
  // ğŸš€ ìµœì í™”ëœ ì¸ë±ìŠ¤
  @@index([userId, hasContent, lastEditedAt])  // í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒìš©
  @@index([userId, isEmpty])                   // ë¹ˆ í”„ë¡œì íŠ¸ í•„í„°ë§ìš©
  @@index([userId, deletedAt])                 // íœ´ì§€í†µ ì¡°íšŒìš©
  @@index([status])
  @@map("project")
}

// í”„ë¡œì íŠ¸ ìƒíƒœ enum
enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  PUBLISHED
  ARCHIVED
}

// í”„ë¡œì íŠ¸-ìºë¦­í„° ê´€ê³„ í…Œì´ë¸”
model ProjectCharacter {
  id                String         @id @default(uuid())
  projectId         String
  project           Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  characterId       String
  character         Character      @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime       @default(now())
  
  @@unique([projectId, characterId])
  @@index([projectId])
  @@index([characterId])
  @@map("project_character")
}

// íŒ¨ë„ ëª¨ë¸ (ì›¹íˆ°ì˜ ê° ì»·)
model Panel {
  id                String         @id @default(uuid())
  projectId         String
  project           Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  order             Int            // íŒ¨ë„ ìˆœì„œ
  prompt            String         @db.Text
  imageUrl          String?
  
  // í¸ì§‘ ë°ì´í„° (ë§í’ì„ , í…ìŠ¤íŠ¸ ë“±)
  editData          Json?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // ê´€ê³„
  generation        Generation?
  
  @@unique([projectId, order])
  @@index([projectId])
  @@map("panel")
}

// AI ìƒì„± ê¸°ë¡
model Generation {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId         String?
  project           Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  panelId           String?        @unique
  panel             Panel?         @relation(fields: [panelId], references: [id], onDelete: SetNull)
  
  characterId       String?
  character         Character?     @relation(fields: [characterId], references: [id], onDelete: SetNull)
  
  // ìƒì„± ì •ë³´
  prompt            String         @db.Text
  negativePrompt    String?        @db.Text
  
  // ê²°ê³¼
  imageUrl          String
  thumbnailUrl      String?
  
  // ë©”íƒ€ë°ì´í„°
  model             String         @default("gemini-2-5-flash-image-preview")
  tokensUsed        Int            @default(2)
  generationTime    Int?           // ë°€ë¦¬ì´ˆ
  metadata          Json?
  
  createdAt         DateTime       @default(now())
  
  @@index([userId])
  @@index([projectId])
  @@map("generation")
}

// ê±°ë˜ ë‚´ì—­
model Transaction {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              TransactionType
  amount            Int            // ì› ë‹¨ìœ„
  tokens            Int?           // í† í° ìˆ˜ëŸ‰
  
  // ê²°ì œ ì •ë³´
  tossPaymentKey    String?
  tossOrderId       String?
  
  status            TransactionStatus @default(PENDING)
  description       String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@index([userId])
  @@index([status])
  @@map("transaction")
}

// ê±°ë˜ ìœ í˜• enum
enum TransactionType {
  SUBSCRIPTION      // êµ¬ë… ê²°ì œ
  TOKEN_PURCHASE    // í† í° êµ¬ë§¤
  TOKEN_USAGE       // í† í° ì‚¬ìš©
  REFUND           // í™˜ë¶ˆ
  REFERRAL_REWARD  // ì¶”ì²œ ë³´ìƒ
}

// ê±°ë˜ ìƒíƒœ enum
enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// ì¶”ì²œì¸ ë³´ìƒ ê¸°ë¡
model ReferralReward {
  id                String         @id @default(uuid())
  
  referrerId        String
  referrer          User           @relation("referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  
  referredId        String
  referred          User           @relation("referred", fields: [referredId], references: [id], onDelete: Cascade)
  
  tokensRewarded    Int            @default(50)
  
  createdAt         DateTime       @default(now())
  
  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
  @@map("referral_reward")
}

// ğŸš€ ì‚¬ìš©ìë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì¶”ì  ëª¨ë¸
model UserStorage {
  id                String         @id @default(uuid())
  userId            String         @unique
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  usedBytes         Int            @default(0) @map("used_bytes")
  fileCount         Int            @default(0) @map("file_count")
  maxBytes          Int            @default(1073741824) @map("max_bytes") // ê¸°ë³¸ 1GB
  
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([usedBytes])
  @@map("user_storage")
}

// ğŸš€ ì¼ì¼ ì‚¬ìš©ëŸ‰ ì§‘ê³„ í…Œì´ë¸” (ì„±ëŠ¥ ìµœì í™”)
model DailyUsageStats {
  id                String         @id @default(uuid())
  userId            String         @map("user_id")
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date              DateTime       @db.Date
  tokensUsed        Int            @default(0) @map("tokens_used")
  imagesGenerated   Int            @default(0) @map("images_generated")
  charactersCreated Int            @default(0) @map("characters_created")
  projectsCreated   Int            @default(0) @map("projects_created")
  storageBytesAdded BigInt         @default(0) @map("storage_bytes_added")
  
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  
  @@unique([userId, date], name: "daily_usage_stats_user_date_unique")
  @@index([userId, date(sort: Desc)], name: "daily_usage_stats_user_date_idx")
  @@index([date(sort: Desc)], name: "daily_usage_stats_date_idx")
  @@map("daily_usage_stats")
}

// ğŸš€ ì‚¬ìš©ìë³„ í˜„ì¬ ì‚¬ìš©ëŸ‰ ìºì‹œ í…Œì´ë¸” (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•œ)
model UserUsageCache {
  id                  String         @id @default(uuid())
  userId              String         @unique @map("user_id")
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  currentMonthTokens  Int            @default(0) @map("current_month_tokens")
  currentMonthImages  Int            @default(0) @map("current_month_images")
  totalCharacters     Int            @default(0) @map("total_characters")
  totalProjects       Int            @default(0) @map("total_projects")
  storageUsedBytes    BigInt         @default(0) @map("storage_used_bytes")
  storageLimitBytes   BigInt         @default(1073741824) @map("storage_limit_bytes")
  
  lastCalculated      DateTime       @default(now()) @map("last_calculated")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  
  @@index([userId], name: "user_usage_cache_user_id_idx")
  @@index([lastCalculated(sort: Desc)], name: "user_usage_cache_last_calculated_idx")
  @@map("user_usage_cache")
}

// ğŸš€ ë¬¸ì˜ì‚¬í•­ ëª¨ë¸ (ê³ ê° ì§€ì›)
model Inquiry {
  id                String         @id @default(uuid())
  userId            String?        @map("user_id")
  user              User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subject           String
  message           String         @db.Text
  category          InquiryCategory @default(general)
  priority          InquiryPriority @default(normal)
  status            InquiryStatus   @default(pending)
  
  // ê´€ë¦¬ì ì‘ë‹µ
  adminResponse     String?        @db.Text @map("admin_response")
  respondedBy       String?        @map("responded_by") // ê´€ë¦¬ì ì´ë©”ì¼
  respondedAt       DateTime?      @map("responded_at")
  
  // ì¶”ê°€ ì •ë³´
  userEmail         String?        @map("user_email") // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì—°ë½ì²˜
  userAgent         String?        @map("user_agent") // ë¸Œë¼ìš°ì € ì •ë³´
  ipAddress         String?        @map("ip_address")
  
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  
  @@index([userId], name: "inquiry_user_id_idx")
  @@index([status], name: "inquiry_status_idx")
  @@index([category], name: "inquiry_category_idx")
  @@index([createdAt(sort: Desc)], name: "inquiry_created_at_idx")
  @@map("inquiry")
}

enum InquiryCategory {
  general     // ì¼ë°˜ ë¬¸ì˜
  technical   // ê¸°ìˆ ì  ë¬¸ì œ
  billing     // ê²°ì œ ê´€ë ¨
  feature     // ê¸°ëŠ¥ ìš”ì²­
  bug         // ë²„ê·¸ ì‹ ê³ 
  account     // ê³„ì • ê´€ë ¨
}

enum InquiryPriority {
  low      // ë‚®ìŒ
  normal   // ë³´í†µ
  high     // ë†’ìŒ
  urgent   // ê¸´ê¸‰
}

enum InquiryStatus {
  pending     // ëŒ€ê¸°
  in_progress // ì²˜ë¦¬ì¤‘
  resolved    // í•´ê²°ë¨
  closed      // ì¢…ë£Œë¨
}