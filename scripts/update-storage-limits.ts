/**
 * ê¸°ì¡´ ì‚¬ìš©ìë“¤ì˜ ìŠ¤í† ë¦¬ì§€ ì œí•œì„ ìƒˆë¡œìš´ í”Œëœ êµ¬ì¡°ì— ë§ê²Œ ì—…ë°ì´íŠ¸
 * ì‹¤í–‰: npx tsx scripts/update-storage-limits.ts
 */

import { config } from 'dotenv';
config({ path: '.env.local' });

import { createClient } from '@supabase/supabase-js';
import { PLAN_CONFIGS } from '@/lib/subscription/plan-config';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Missing Supabase environment variables');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function updateStorageLimits() {
  console.log('ğŸš€ Starting storage limits migration...');
  
  try {
    // ëª¨ë“  ì‚¬ìš©ìì˜ êµ¬ë…ê³¼ ìŠ¤í† ë¦¬ì§€ ì •ë³´ ì¡°íšŒ
    const { data: subscriptions, error: subError } = await supabase
      .from('subscription')
      .select('userId, plan');
      
    if (subError) {
      console.error('âŒ Failed to fetch subscriptions:', subError);
      return;
    }
    
    console.log(`ğŸ“‹ Found ${subscriptions.length} subscriptions to process`);
    
    let updated = 0;
    let errors = 0;
    
    for (const subscription of subscriptions) {
      try {
        const { userId, plan } = subscription;
        const planConfig = PLAN_CONFIGS[plan as keyof typeof PLAN_CONFIGS];
        
        if (!planConfig) {
          console.warn(`âš ï¸  Unknown plan ${plan} for user ${userId.slice(0, 8)}`);
          continue;
        }
        
        const newStorageLimit = planConfig.storageLimit;
        
        // í˜„ì¬ ìŠ¤í† ë¦¬ì§€ ì •ë³´ ì¡°íšŒ
        const { data: currentStorage } = await supabase
          .from('user_storage')
          .select('max_bytes')
          .eq('userId', userId)
          .single();
          
        if (currentStorage?.max_bytes === newStorageLimit) {
          console.log(`âœ… User ${userId.slice(0, 8)} (${plan}): Already up to date`);
          continue;
        }
        
        // ìŠ¤í† ë¦¬ì§€ ì œí•œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë ˆì½”ë“œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸)
        const { error: updateError } = await supabase
          .from('user_storage')
          .update({
            max_bytes: newStorageLimit,
            updated_at: new Date().toISOString()
          })
          .eq('userId', userId);
          
        if (updateError) {
          console.error(`âŒ Failed to update user ${userId.slice(0, 8)}:`, updateError);
          errors++;
        } else {
          const oldGB = currentStorage?.max_bytes ? 
            (currentStorage.max_bytes / 1024 / 1024 / 1024).toFixed(1) : 'N/A';
          const newGB = (newStorageLimit / 1024 / 1024 / 1024).toFixed(1);
          
          console.log(`ğŸ”„ User ${userId.slice(0, 8)} (${plan}): ${oldGB}GB â†’ ${newGB}GB`);
          updated++;
        }
        
      } catch (error) {
        console.error(`âŒ Error processing user ${subscription.userId.slice(0, 8)}:`, error);
        errors++;
      }
    }
    
    console.log('\nğŸ“Š Migration Summary:');
    console.log(`âœ… Updated: ${updated} users`);
    console.log(`âŒ Errors: ${errors} users`);
    console.log(`ğŸ“‹ Total processed: ${subscriptions.length} users`);
    
    if (errors === 0) {
      console.log('\nğŸ‰ Storage limits migration completed successfully!');
    } else {
      console.log(`\nâš ï¸  Migration completed with ${errors} errors. Please check the logs.`);
    }
    
  } catch (error) {
    console.error('âŒ Migration failed:', error);
  }
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
updateStorageLimits();